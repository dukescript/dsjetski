/**
 * Copyright (c) 2014, 2015, Oracle and/or its affiliates.
 * All rights reserved.
 */
"use strict";
define(["ojs/ojcore","jquery","ojs/ojdatacollection-common","ojs/ojmodel"],function(a){a.Vd=function(a,d,b,c,e){this.QB=a;this.Ea=d;this.qJ=[];this.Vw=b;this.start=c<d.length?c:d.length-1;this.count=-1===e?d.length:Math.min(d.length,e)};o_("CollectionNodeSet",a.Vd,a);a.Vd.prototype.GL=function(a){this.IQ(this).then(function(){a.success&&a.success()})};a.Vd.prototype.IQ=function(a){return new Promise(function(d){function b(e){e<c?a.w0(e,{success:function(c){null!==c?a.IQ(c).then(function(){b(e+1)}):
b(e+1)}}):d(void 0)}var c=a.R();b(0)})};a.Vd.prototype.w0=function(a,d){var b=this.Ea.at(a);if(this.Vw.Es(b).leaf)this.qJ[a]=null,d.success(null);else{var c=this.Vw.Yw(b),b=this.Vw.Es(b).key,e=this;this.Vw.Os(c,0,-1,{success:function(b){e.qJ[a]=b;d.success(b)}},b)}};a.Vd.prototype.getParent=function(){return this.QB};a.b.i("CollectionNodeSet.prototype.getParent",{getParent:a.Vd.prototype.getParent});a.Vd.prototype.ua=function(){return this.start};a.b.i("CollectionNodeSet.prototype.getStart",{ua:a.Vd.prototype.ua});
a.Vd.prototype.R=function(){return this.count};a.b.i("CollectionNodeSet.prototype.getCount",{R:a.Vd.prototype.R});a.Vd.prototype.getData=function(a){this.yE(a);return this.Ea.at(a).attributes};a.b.i("CollectionNodeSet.prototype.getData",{getData:a.Vd.prototype.getData});a.Vd.prototype.yE=function(a){if(a<this.start||a>this.start+this.count)throw"Out of range";};a.Vd.prototype.getMetadata=function(a){this.yE(a);var d={};a=this.Ea.at(a);a=this.Vw.Es(a);d.key=a.key;d.leaf=a.leaf;d.depth=a.depth;return d};
a.b.i("CollectionNodeSet.prototype.getMetadata",{getMetadata:a.Vd.prototype.getMetadata});a.Vd.prototype.pf=function(a){this.yE(a);return this.qJ[a]};a.b.i("CollectionNodeSet.prototype.getChildNodeSet",{pf:a.Vd.prototype.pf});a.Ka=function(f){f=f||{};this.Ow=f.root;this.kfa=f.childCollectionCallback;this.Es=f.parseMetadata;this.Hp=null;this.Js="none";this.Dd={};a.Ka.q.constructor.call(this)};o_("CollectionTreeDataSource",a.Ka,a);a.Ka.prototype.Es=function(a){return{key:a.idAttribute+"\x3d"+a.id}};
a.b.ga(a.Ka,a.Uc,"oj.CollectionTreeDataSource");a.Ka.prototype.Init=function(){a.Ka.q.Init.call(this)};a.b.i("CollectionTreeDataSource.prototype.Init",{Init:a.Ka.prototype.Init});a.Ka.prototype.nf=function(a){var d=this.Dd[a];if(d&&0<d.length)return d.length;this.MJ(a,{success:function(a){return a.length}});return-1};a.b.i("CollectionTreeDataSource.prototype.getChildCount",{nf:a.Ka.prototype.nf});a.Ka.prototype.MJ=function(a,d){this.Rd(a,null,{success:function(a){d.success(a.Ea)},error:d.error})};
a.b.i("CollectionTreeDataSource.prototype.getChildCollection",{MJ:a.Ka.prototype.MJ});a.Ka.prototype.Rd=function(a,d,b){d=d||{};var c=d.start?d.start:0,e=d.count?d.count:-1;if(null===a)this.Os(null,c,e,b,null);else{var g=this;this.YF(this.Ow,a,0).then(function(d){if(d){d=g.Yw(d.un);try{g.Os(d,c,e,b,a)}catch(k){b&&b.error&&b.error({status:k.message})}}else b&&b.error&&b.error(a)})}};a.b.i("CollectionTreeDataSource.prototype.fetchChildren",{Rd:a.Ka.prototype.Rd});a.Ka.prototype.M0=function(a,d,b){var c=
0;b&&b.at&&(c=b.at);d=this.oz(d);a=this.wy(this,"insert",c,d,this.IU(null!=d&&0<d.length?d[d.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.N0=function(a,d,b){var c=0;b&&b.index&&(c=b.index);this.sca(a);a=this.wy(this,"delete",c,this.oz(d),null);this.handleEvent("change",a)};a.Ka.prototype.O0=function(a){var d=this.D7(a),b=null,c=null;d&&(b=d.index,c=this.oz(d.Ea));a=this.wy(this,"update",b,c,this.IU(null!=c&&0<c.length?c[c.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.o0=
function(a){a=this.wy(this,"refresh",null,this.oz(a),null);this.handleEvent("refresh",a)};a.Ka.prototype.IU=function(f,d){var b=new a.l;b.add(d);return this.MR(b,f,0,1)};a.Ka.prototype.oz=function(f){var d=[],b=null;do b=this.B8(f),null!==b&&(b!==a.Ka.dM&&d.unshift(b),f=this.E7(b));while(null!=b);return d};a.Ka.dM="%!@ROOT%#@!";a.Ka.prototype.Yy=function(f){var d=f instanceof a.t?this.Es(f).key:f;return f?d:a.Ka.dM};a.Ka.prototype.kO=function(a){return this.Dd[this.Yy(a)]};a.Ka.prototype.OV=function(f,
d){d.on(a.$.F.ADD,this.M0,this);d.on(a.$.F.REMOVE,this.N0,this);d.on(a.$.F.CHANGE,this.O0,this);d.on(a.$.F.SYNC,this.o0,this);this.Dd[this.Yy(f)]=d};a.Ka.prototype.sca=function(a){a=this.Yy(a);for(var d in this.Dd)if(this.Dd.hasOwnProperty(d)&&d===a){this.Dd[a].off(null,null,this);delete this.Dd[a];break}};a.Ka.prototype.vaa=function(a,d){for(var b=d.length,c=0;c<b;c++){var e=this.Yy(d.at(c));if(a===e)return!0}return!1};a.Ka.prototype.D7=function(a){for(var d in this.Dd)if(this.Dd.hasOwnProperty(d))for(var b=
this.Dd[d],c=0;c<b.length;c++)if(b.at(c)===a)return{index:c,Ea:b};return null};a.Ka.prototype.E7=function(a){for(var d in this.Dd)if(this.Dd.hasOwnProperty(d)){var b=this.Dd[d];if(this.vaa(a,b))return b}return null};a.Ka.prototype.B8=function(a){for(var d in this.Dd)if(this.Dd.hasOwnProperty(d)&&this.Dd[d]===a)return d;return null};a.Ka.prototype.Yw=function(a){var d=!0,b=this.kO(a);b||(d=!1,b=this.kfa(this.Ow,a),null!=b&&(this.AO(b),this.OV(a,b)));return{Ea:b,nJ:d}};a.Ka.prototype.wy=function(a,
d,b,c,e){return{source:a,operation:d,index:b,parent:c,data:e}};a.Ka.prototype.Os=function(a,d,b,c,e){var g=this;null===a&&((a=this.kO(null))?a={Ea:a,nJ:!0}:(a={Ea:g.Ow,nJ:!1},g.OV(null,this.Ow)));a&&g.FQ(a,function(a){c.success&&c.success(g.MR(a,e,d,b))},c.error)};a.Ka.prototype.MR=function(f,d,b,c){return new a.Vd(d,f,this,b,c)};a.Ka.prototype.bda=function(a,d){var b=this;return new Promise(function(c){function e(a,d,f){a<d.length?d.at(a,{deferred:!0}).then(function(l){if(l){var m=b.Es(l);if(f===
m.key){c(l);return}}a++;e(a,d,f)}):c(null)}e(0,a,d)})};a.Ka.prototype.YF=function(a,d,b){var c=this;return new Promise(function(e){c.bda(a,d).then(function(g){function h(c,g){if(c<k){var n=g.Yw(a.at(c));n.Ea?g.FQ(n,function(a){g.YF(a,d,b+1).then(function(a){a?e(a):(c++,h(c,g))})},null):(c++,h(c,g))}else e(null)}if(g)e({un:g,depth:b});else{var k=a.length;h(0,c)}})})};a.Ka.prototype.FQ=function(a,d,b){a.nJ?d(a.Ea):(this.Hp&&"none"!==this.Hp&&(a.Ea.vJ=this.Hp,a.Ea.fL=this.Js),0<a.Ea.length||!a.Ea.G0()?
d(a.Ea):a.Ea.fetch({success:function(a){d(a)},error:b}))};a.Ka.prototype.ll=function(a,d){var b=this;null===a?this.Os(null,0,-1,{success:function(a){a.GL({success:function(){d.success&&d.success(a)}})}},null):this.YF(this.Ow,a,0).then(function(c){c&&(c=b.Yw(c.un),b.Os(c,0,-1,{success:function(a){a.GL({success:function(){d.success&&d.success(a)}})}},a))})};a.b.i("CollectionTreeDataSource.prototype.fetchDescendants",{ll:a.Ka.prototype.ll});a.Ka.prototype.sort=function(a,d){var b=a.key,c=a.direction,
e=!1;b!==this.Hp&&(this.Hp=b,e=!0);c!==this.Js&&(this.Js=c,e=!0);if(e){"none"===this.Js&&(this.Dd={});for(var g in this.Dd)this.Dd.hasOwnProperty(g)&&this.AO(this.Dd[g])}d&&d.success&&d.success()};a.b.i("CollectionTreeDataSource.prototype.sort",{sort:a.Ka.prototype.sort});a.Ka.prototype.AO=function(a){a.comparator=this.Hp;a.sortDirection="ascending"===this.Js?1:-1;a.sort()};a.Ka.prototype.lw=function(){return{key:this.Hp,direction:this.Js}};a.b.i("CollectionTreeDataSource.prototype.getSortCriteria",
{lw:a.Ka.prototype.lw});a.Ka.prototype.move=function(){a.j.Ya()};a.b.i("CollectionTreeDataSource.prototype.move",{move:a.Ka.prototype.move});a.Ka.prototype.cj=function(){return"invalid"};a.b.i("CollectionTreeDataSource.prototype.moveOK",{cj:a.Ka.prototype.cj});a.Ka.prototype.getCapability=function(a){return"sort"===a?"default":"move"===a?"none":"batchFetch"===a||"fetchDescendants"===a?"disable":null};a.b.i("CollectionTreeDataSource.prototype.getCapability",{getCapability:a.Ka.prototype.getCapability})});